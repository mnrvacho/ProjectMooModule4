# Azure AI Search로 Azure OpenAI 텍스트 및 이미지 벡터 검색 (Azure Portal)

이 가이드는 Azure Portal에서 **Azure AI Search의 데이터 가져오기 및 벡터화 마법사**를 사용합니다. 콘텐츠를 청크 분할하고, embedding 모델을 호출하여 인덱싱 및 쿼리 중에 콘텐츠를 벡터화합니다. 본 실습은 [Microsoft Learn (빠른 시작: Azure Portal을 사용하여 텍스트 및 이미지 벡터화)](https://learn.microsoft.com/ko-kr/azure/search/search-get-started-portal-import-vectors)를 활용합니다.

<br/>

## 사전 확인 사항

* **Azure 구독** : Azure OpenAI, Azure AI Service, Azure AI Search, Azure Storage Account 등의 리소스 권한  
* 활용 가능한 **텍스트 임베딩 모델**:
  * Azure OpenAI: text-embedding-ada-002, text-embedding-3-large, text-embedding-3-small
  * Azure AI Foundry 모델 카탈로그: Cohere-embed-v3-english, Cohere-embed-v3-multilingual
* 활용 가능한 **이미지 임베딩 모델**:
  * Azure AI Foundry 모델 카탈로그: Facebook-DinoV2-Image-Embeddings-ViT-Base, Facebook-DinoV2-Image-Embeddings-ViT-Giant
  * Azure AI Service: Computer Vision
* **Azure AI Search의 데이터 가져오기 및 벡터화 마법사**는 Blob 및 테이블용 Azure Blob Storage, ADLS(Azure Data Lake Storage) Gen2, Fabric의 OneLake 등 Azure의 다양한 데이터 원본을 지원하며, 이 가이드는 Azure Blob Storage를 활용합니다.
* Azure AI Search와 Azure AI Service는 동일한 지역(ex. West US)에 있어야 하며, 기본 계층 이상 권장 
* PDF 샘플데이터 [(다운로드)](https://github.com/Azure-Samples/azure-search-sample-data/tree/main/health-plan)  
  <img src="https://github.com/user-attachments/assets/93dd5cac-907b-432d-98f4-7995d70686c3" width="40%" height="40%">

  <br/>

## 시작 

### Azure AI Search 생성
1. [Azure Portal](https://portal.azure.com/)에서 Azure AI Search 리소스를 생성합니다 (ex. West US). [Microsoft Learn: Azure Portal에서 Azure AI Search 서비스 만들기](https://learn.microsoft.com/ko-kr/azure/search/search-create-service-portal)를 참고하세요. 

2. 리소스 생성 후 Azure AI Search의 [설정] > [키] -> API 액세스 제어 **둘 다** 선택 후 [저장] 
  ![Image](https://github.com/user-attachments/assets/958d463f-fbb5-49b3-87b1-76225bcb86e3)


3. Azure AI Search의 좌측메뉴 [설정] > [관리 ID] -> Status **On** 선택 후 [저장] 
  ![Image](https://github.com/user-attachments/assets/1cb80ec2-3a22-4cfe-9fe6-6d12ee3f153e)


<br/> 


### Azure Storage Account (Blob Storage) 구성 

1. [Azure Portal](https://portal.azure.com/)에서 Azure 스토리지 계정 리소스를 생성합니다 (ex. West US). [Azure Storage 계정 만들기](https://learn.microsoft.com/ko-kr/azure/storage/common/storage-account-create?tabs=azure-portal)를 참고하세요.

2. 리소스 생성 후 Azure 스토리지 계정의 [데이터 스토리지] -> [컨테이너]에서 새 컨테이너 'health-plan-pdfs'을 [생성]
  ![Image](https://github.com/user-attachments/assets/6522ada6-94e6-4992-8fa9-b6b0b50ec6ac)


3. 컨테이너 'health-plan-pdfs'에서 PDF 데이터 샘플 파일을 모두 [업로드]
  ![Image](https://github.com/user-attachments/assets/e23ebceb-a79d-4a20-b14c-31ae57402430) 


  ![image](https://github.com/user-attachments/assets/26b314e8-8a3f-4e4d-9988-b13360c7c7f3)



4. Azure 스토리지 계정의 [액세스 제어(IAM)] -> [+추가] -> [역할 할당 추가] 
  ![image](https://github.com/user-attachments/assets/21c44224-0ef8-4723-b2db-cd79d4c77255) 


5. **Storage Blob 데이터 Reader** 선택 후 [다음] -> **관리 ID** -> [+구성원 선택] -> 해당 구독, '관리 ID': **Search Service**, 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]
  ![Image](https://github.com/user-attachments/assets/d636e31f-68ae-40d6-8978-bd66b6c62a44) 


6. 컨테이너와 검색 인덱스 삭제 작업을 동기화해야 할 경우, 스토리지 계정 좌측 메뉴 [데이터 관리] -> [데이터 보호] -> **Blob에 일시 삭제 사용** 체크 -> [저장]

<br/>   


### Azure OpenAI 구성 

1. [Azure Portal](https://portal.azure.com/)에서 Azure OpenAI 리소스를 생성(ex. West US) 후, **Azure AI Foundry Portal**으로 이동하여 텍스트 임베딩 모델을 배포합니다. 이 가이드에서는 **text-embedding-ada-002**을 활용합니다. [Azure OpenAI Service 리소스 생성 및 배포](https://learn.microsoft.com/ko-kr/azure/ai-services/openai/how-to/create-resource?pivots=web-portal)를 참고하세요.

2. Azure Portal의 Azure OpenAI 좌측 메뉴 [액세스 제어(IAM)] -> [+추가] -> [역할 할당 추가] -> **Cognitive Services OpenAI 사용자** 선택 후 [다음] -> **관리 ID** -> [+구성원 선택]

3. 해당 구독 선택 -> '관리 ID': **Search Service** -> 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]


<br/> 


### Azure AI 서비스 구성 

1. [Azure Portal](https://portal.azure.com/)에서 Azure AI Service 리소스를 생성합니다(ex. West US). [빠른 시작: Azure AI 서비스 리소스 만들기](https://learn.microsoft.com/ko-kr/azure/ai-services/multi-service-resource?pivots=azportal) 가이드를 참고하세요.

2. **Azure AI Foundry Portal**으로 이동하여 [+프로젝트 만들기] -> '프로젝트 이름' 입력 -> [만들기]

3. 좌측 메뉴 [모델 카탈로그]에서 이미지 임베딩 모델을 선택 후 [배포]. 이 가이드에서는 **Facebook-DinoV2-Image-Embeddings-ViT-Base** 모델을 활용합니다.

4. Azure Portal의 Azure AI Service 좌측 메뉴 [액세스 제어(IAM)] -> [+추가] -> [역할 할당 추가] -> **Cognitive Services 사용자** 선택 후 [다음] -> **관리 ID** -> [+구성원 선택]

3. 해당 구독 선택 -> '관리 ID': **Search Service** -> 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]



<br/> 


### Azure AI Search의 데이터 가져오기 및 벡터화 마법사 

1. Azure Portal에서 생성한 Azure AI Search 리소스의 [개요] 화면 중앙상단의 [**데이터 가져오기 및 벡터화**] 선택

2. '데이터 연결'에서 [Azure Blob Storage] -> 해당 구독과 생성된 Azure 스토리지 계정 (Blob Storage)와 컨테이너 선택

3. 컨테이너와 검색 인덱스 삭제 작업을 동기화해야 할 경우, '삭제 추적 사용' - '네이티브 Blob 일시 삭제' 선택 후 [다음]

4. '텍스트 벡터화'에서 [Azure OpenAI] -> 해당 구독과 생성된 Azure OpenAI와 모델 선택 -> 인증 유형 '시스템 할당 ID' 선택 후 [다음]

5. '이미지 벡터화 및 보강'에서 -> '벡터화 이미지' 체크 -> [AI Foundry 카탈로그 모델] -> 해당 구독, 생성된 프로젝트와 모델 선택 -> 인증 유형 '시스템 할당 ID' 선택

6. 'AI 기술로 데이터 보강' 체크 -> 해당 구독과 생성된 Azure AI Service 선택 -> 인증 유형 '시스템 할당 ID' 선택 후 [다음]

7. '고급 설정' -> [다음]

8. '검토 및 만들기' -> [만들기] 


<br/> 


### 


1. [Azure Portal](https://portal.azure.com/)에서 Azure SQL Database를 생성합니다. [빠른 시작: Azure Portal을 사용하여 Azure SQL Database에서 단일 데이터베이스 만들기](https://docs.microsoft.com/azure/azure-sql/database/single-database-create-quickstart?tabs=azure-portal) 가이드에 따라 새 Azure SQL Database를 만들 수 있습니다.

1. 기존 SQL Database Server가 없는 경우 새로 생성합니다. **Authentication method**는 **'Use both SQL and Microsoft Entra authentication'**으로 선택하여 *Server admin login 정보*를 입력합니다. **Compute + Storage**는 **'Basic: 2GB 스토리지'**, **Backup storage redundancy**는 **'Locally-redundant backup'** 을 선택합니다. 
<img src="https://github.com/user-attachments/assets/197a13e5-5aed-407d-ab71-e2f4875e1dc4"  width="500">

1. `01-create-table.sql` 를 사용하여 Walmart 데이터 세트를 가져올 테이블 `walmart_ecommerce_product_details`을 만듭니다. https://github.com/mnrvacho/ProjectMooModule2/blob/main/2.%20sqldb%20scripts/01-create-table.sql 
  
1. Azure SQL DB 생성 시 입력한 **SQL server authentication 정보 또는 Microsoft Entra** 를 이용하여 쿼리편집기에 연결합니다. 

    ![image](https://github.com/user-attachments/assets/147bdc3b-70ac-403e-b318-b1f2b0dbc108)

    ![image](https://github.com/user-attachments/assets/682fcd50-487e-44dd-8db5-464be6805b31)

  <br/> 


### Vector Embeddings로 보강된 공개 Walmart US Product 데이터 세트 다운로드
















