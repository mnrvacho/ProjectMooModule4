# Azure AI Search로 벡터 검색 (Azure Portal)

이 가이드는 Azure Portal에서 **Azure AI Search의 데이터 가져오기 및 벡터화 마법사**를 사용합니다. 콘텐츠를 청크 분할하고, embedding 모델을 호출하여 인덱싱 및 쿼리 중에 콘텐츠를 벡터화합니다. 본 실습은 [Microsoft Learn (빠른 시작: Azure Portal을 사용하여 텍스트 및 이미지 벡터화)](https://learn.microsoft.com/ko-kr/azure/search/search-get-started-portal-import-vectors)를 활용합니다.

<br/>

## 사전 확인 사항

* **Azure 구독** : Azure OpenAI, Azure AI Service, Azure AI Search, Azure Storage Account 등의 리소스 권한  

* 활용 가능한 **텍스트 임베딩 모델**:
  * Azure OpenAI: `text-embedding-ada-002`, `text-embedding-3-large`, `text-embedding-3-small`
  * Azure AI Foundry 모델 카탈로그: `Cohere-embed-v3-english`, `Cohere-embed-v3-multilingual`

* 활용 가능한 **이미지 임베딩 모델**:
  * Azure AI Foundry 모델 카탈로그: `Facebook-DinoV2-Image-Embeddings-ViT-Base`, `Facebook-DinoV2-Image-Embeddings-ViT-Giant`
  * Azure AI Service: `Computer Vision`

* **Azure AI Search의 데이터 가져오기 및 벡터화 마법사**는 아래 Azure의 다양한 데이터 원본을 지원합니다. 
  이 가이드는 Azure Blob Storage를 활용합니다.
  * Blob / File / Table 용 Azure Blob Storage
  * ADLS(Azure Data Lake Storage) Gen2
  * Fabric의 OneLake
  * CosmosDB
   등 [자세히](https://learn.microsoft.com/ko-kr/azure/search/search-import-data-portal#supported-data-sources-and-scenarios) 

* Azure AI Search와 Azure AI Service는 동일한 지역에 있어야 하며, 기본 계층 이상 권장
 
* PDF 샘플데이터 [(다운로드)](https://github.com/Azure-Samples/azure-search-sample-data/tree/main/health-plan)  
  <img src="https://github.com/user-attachments/assets/93dd5cac-907b-432d-98f4-7995d70686c3" width="30%" height="30%">

<br/> 

### 실습 순서 

1. Azure AI Search 구성
2. Azure Storage Account (Blob Storage) 구성
3. Azure OpenAI 구성
4. Azure AI 서비스 구성
5. Azure AI Search 데이터 가져오기 및 벡터화 마법사
6. Azure AI Search 결과 확인


<br/> 

## 시작 

### Azure AI Search 구성 
1. [Azure Portal](https://portal.azure.com/)에서 Azure AI Search 리소스를 생성합니다 (ex. West US). [Microsoft Learn: Azure Portal에서 Azure AI Search 서비스 만들기](https://learn.microsoft.com/ko-kr/azure/search/search-create-service-portal)를 참고하세요. 

2. 리소스 생성 후 Azure AI Search의 `설정` > `키` > 'API 액세스 제어' **둘 다** 선택 후 [저장] 

  ![Image](https://github.com/user-attachments/assets/958d463f-fbb5-49b3-87b1-76225bcb86e3)


3. Azure AI Search의 `설정` > `관리 ID` > 'Status' **On** 선택 후 [저장] 

  ![Image](https://github.com/user-attachments/assets/1cb80ec2-3a22-4cfe-9fe6-6d12ee3f153e)


<br/> 


### Azure Storage Account (Blob Storage) 구성 

1. Azure Portal에서 Azure 스토리지 계정 리소스를 생성합니다 (ex. West US). [Azure Storage 계정 만들기](https://learn.microsoft.com/ko-kr/azure/storage/common/storage-account-create?tabs=azure-portal)를 참고하세요.

2. 리소스 생성 후 Azure 스토리지 계정의 `데이터 스토리지` > `컨테이너`에서 새 컨테이너 'health-plan-pdfs'을 [생성] 

  ![Image](https://github.com/user-attachments/assets/6522ada6-94e6-4992-8fa9-b6b0b50ec6ac)


3. `컨테이너` 'health-plan-pdfs' > `업로드`에서 PDF 데이터 샘플 파일을 모두 [업로드]

  ![Image](https://github.com/user-attachments/assets/e23ebceb-a79d-4a20-b14c-31ae57402430) 


  ![image](https://github.com/user-attachments/assets/26b314e8-8a3f-4e4d-9988-b13360c7c7f3)



4. Azure 스토리지 계정의 `액세스 제어(IAM)` > `+추가` > `역할 할당 추가` 

  ![image](https://github.com/user-attachments/assets/21c44224-0ef8-4723-b2db-cd79d4c77255) 


5. **Storage Blob 데이터 Reader** 선택 후 [다음] -> **관리 ID** -> `+구성원 선택` -> 해당 구독, '관리 ID': **Search Service**, 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]

  ![Image](https://github.com/user-attachments/assets/d636e31f-68ae-40d6-8978-bd66b6c62a44) 


6. 컨테이너와 검색 인덱스 삭제 작업을 동기화해야 할 경우, 스토리지 계정의 `데이터 관리` -> `데이터 보호` -> **Blob에 일시 삭제 사용** 체크 > [저장]

<br/>   


### Azure OpenAI 구성 

1. Azure Portal에서 Azure OpenAI 리소스를 생성(ex. West US) 후, **Azure AI Foundry Portal**으로 이동하여 텍스트 임베딩 모델을 배포합니다. 이 가이드에서는 **text-embedding-ada-002**을 활용합니다. [Azure OpenAI Service 리소스 생성 및 배포](https://learn.microsoft.com/ko-kr/azure/ai-services/openai/how-to/create-resource?pivots=web-portal)를 참고하세요.

2. Azure OpenAI의 `액세스 제어(IAM)` > `+추가` > `역할 할당 추가`에서 **Cognitive Services OpenAI 사용자** 선택 후 [다음] -> **관리 ID** -> `+구성원 선택`

3. 해당 구독 선택 -> '관리 ID': **Search Service** -> 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]


<br/> 


### Azure AI 서비스 구성 

1. Azure Portal에서 Azure AI Service 리소스를 생성합니다(ex. West US). [빠른 시작: Azure AI 서비스 리소스 만들기](https://learn.microsoft.com/ko-kr/azure/ai-services/multi-service-resource?pivots=azportal) 가이드를 참고하세요.

2. **Azure AI Foundry Portal**으로 이동하여 `+프로젝트 만들기` -> '프로젝트 이름' 입력 -> [만들기]

3. `모델 카탈로그`에서 이미지 임베딩 모델을 선택 후 [배포]. 이 가이드에서는 **Facebook-DinoV2-Image-Embeddings-ViT-Base** 모델을 활용합니다.

4. Azure Portal에서 Azure AI Service의 `액세스 제어(IAM)` > `+추가` > `역할 할당 추가`에서 **Cognitive Services 사용자** 선택 후 [다음] -> **관리 ID** -> `+구성원 선택` 

3. 해당 구독 선택 -> '관리 ID': **Search Service** -> 해당 Azure AI Search 서비스 [선택] -> [검토 + 할당]



<br/> 


### Azure AI Search 데이터 가져오기 및 벡터화 마법사 

1. Azure Portal에서 생성한 Azure AI Search 리소스의 [개요] > `**데이터 가져오기 및 벡터화**` 선택

2. '데이터 연결'에서 `Azure Blob Storage` -> 해당 구독과 생성된 Azure 스토리지 계정 (Blob Storage)와 컨테이너 선택

3. 컨테이너와 검색 인덱스 삭제 작업을 동기화해야 할 경우, `삭제 추적 사용` - `네이티브 Blob 일시 삭제` 선택 후 [다음]

4. '텍스트 벡터화'에서 `Azure OpenAI` -> 해당 구독과 생성된 Azure OpenAI와 모델 선택 -> 인증 유형 `시스템 할당 ID` 선택 후 [다음]

5. '이미지 벡터화 및 보강'에서 -> `벡터화 이미지` 체크 -> `AI Foundry 카탈로그 모델` -> 해당 구독, 생성된 프로젝트와 모델 선택 -> 인증 유형 `시스템 할당 ID` 선택

6. `AI 기술로 데이터 보강` 체크 -> 해당 구독과 생성된 Azure AI Service 선택 -> 인증 유형 `시스템 할당 ID` 선택 후 [다음]

7. '고급 설정' -> [다음]

8. '검토 및 만들기' -> [만들기]

9. 마법사가 구성을 완료하면 다음 개체가 만들어집니다.
   * 데이터 소스
   * 인덱스: 벡터 필드, 벡터라이저, 벡터 프로필 및 벡터 알고리즘으로 생성 
   * 인덱서: 필드 매핑 및 출력 필드 매핑
   * 기술 세트(skillset): 청킹을 위한 텍스트 분할과 벡터화를 위한 embedding 기술을 갖춤. 
     Azure OpenAI의 임베딩 모델 또는 AI Foundry 모델카탈로그에 대한 AML. [자세히](https://learn.microsoft.com/ko-kr/azure/search/search-import-data-portal#skills) 


<br/> 


### Azure AI Search 결과 확인 

1. Azure Portal의 Azure AI Search에서 `검색 관리` > `인덱스`에서 생성된 인덱스 선택 

   ![Image](https://github.com/user-attachments/assets/9e8b290d-9a9e-43d2-bd2a-9ddac42ba42a) 


2. 검색을 테스트해봅니다. `"*"` [검색] 

   ![Image](https://github.com/user-attachments/assets/8b29c3f7-ba5a-4235-8828-f877ead739db) 


3. [쿼리 옵션]에서 '벡터 검색'을 끄면 벡터값을 숨겨 검색 결과를 더 쉽게 읽을 수 있습니다. 

   ![Image](https://github.com/user-attachments/assets/53b0424b-8fd8-42fc-8cbf-41407fcabf41) 


4. `의미 체계 구성` 탭탭에서 생성된 semantic configuration을 확인할 수 있습니다. 

   ![Image](https://github.com/user-attachments/assets/086e64a5-023e-46f4-bfae-bc3ba3ac1b88)


5. `검색 탐색기`의 [보기] 메뉴에서 'JSON 뷰' 선택 시 벡터 쿼리에 대한 매개변수 `"text_vector"`를 입력할 수 있습니다. 
   
   ![image](https://github.com/user-attachments/assets/af32f2b5-99f2-4440-a5e9-8ffb7d45da41)


   (`"semanticConfiguration"` 이름 확인*) 
    ```bash
    {
    "search": "*",
    "count": true,
    "vectorQueries": [
      {
        "kind": "text",
        "text": "*",
        "fields": "text_vector"
      }
    ],
    "queryType": "semantic",
    "semanticConfiguration": "vector-1738506692142-semantic-configuration",
    "captions": "extractive",
    "answers": "extractive|count-3",
    "queryLanguage": "en-us",
    "select": "chunk_id,parent_id,chunk,title"
    }
    ```
   

   기본 쿼리는 빈 검색(`"*"`)이지만 숫자 일치를 반환하기 위한 매개변수를 포함합니다. 의미 체계 순위가 포함되어 있고, `select`에 반환할 필드를 지정합니다. 텍스트 및 벡터 쿼리를 병렬로 실행하는 **하이브리드 검색**입니다. 
   더 자세히: 
     * [Azure AI Search 하이브리드 검색](https://learn.microsoft.com/ko-kr/azure/search/hybrid-search-how-to-query))
     * [Azure AI Search 벡터 검색](https://learn.microsoft.com/ko-kr/azure/search/vector-search-how-to-query) 


   ![Image](https://github.com/user-attachments/assets/582e3ca1-d858-488d-840b-bad7dba76ae9) 

   
6. 별표(*) 자리 표시자를 질문으로 대체합니다. (예: `Which plan has the lowest deductible?`)
   
   ```bash
   {
   "search": "Which plan has the lowest deductible?",
   "count": true,
   "vectorQueries": [
     {
       "kind": "text",
       "text": "Which plan has the lowest deductible?",
       "fields": "text_vector"
     }
   ],
   "queryType": "semantic",
   "semanticConfiguration": "vector-1738506692142-semantic-configuration",
   "captions": "extractive",
   "answers": "extractive|count-3",
   "queryLanguage": "en-us",
   "select": "chunk_id,parent_id,chunk,title"
   }
   ``` 
   
   ![Image](https://github.com/user-attachments/assets/2003fb54-b0e5-484e-b234-4b4b741ea174)


7. 쿼리 실행하려면 [보기] 메뉴에서 '쿼리 뷰' 선택
   
   ![Image](https://github.com/user-attachments/assets/f1b05b6b-8f09-4360-bc66-67c5f1afc55d) 

   각 문서는 원본 PDF의 일부입니다. `title` 필드는 청크가 어느 PDF에서 나오는지 보여 줍니다. 

8. `필드` 탭에서 필터링 할 수 있는 필드를 확인할 수 있습니다. 특정 문서에서 모든 청크를 보려면 특정 PDF의 `parent_id` 필드에 대한 필터를 추가합니다. 

   ![image](https://github.com/user-attachments/assets/c3b0fe93-5f2a-46df-bc9d-fa750dfa5c5d)

   (`"parent_id"` 확인*)
   ```bash
   {
   "select": "chunk_id,parent_id,chunk,title",
   "filter": "parent_id eq 'aHR0cHM6Ly9zdGFkbWluYWk2MDM0MTI4NzY4MTMuYmxvYi5jb3JlLndpbmRvd3MubmV0L2hlYWx0aC9Ob3J0aHdpbmRfSGVhbHRoX1BsdXNfQmVuZWZpdHNfRGV0YWlscy5wZGY1'",
   "count": true,
   "vectorQueries": [
       {
          "kind": "text",
          "text": "*",
          "k": 5,
          "fields": "text_vector"
       }
    ]
    }

   
  ![Image](https://github.com/user-attachments/assets/f7f45518-eb07-4874-8ed0-4bf47ee36452) 


<br/> 


## 다음 단계 

* [Azure AI Search Rest API로 벡터 검색 (Python)](https://github.com/mnrvacho/ProjectMooModule4/blob/main/2.%20Vector%20Search%20-%20Rest%20API.md)
* [Azure AI Content Understanding과 Azure AI Search 연결 (Python)](https://github.com/mnrvacho/ProjectMooModule4/blob/main/3.%20Azure%20Content%20Understanding%20-%20Rest%20API.md) 
<br/> 
또는 

### 리소스정리
Azure AI 검색은 청구 가능한 리소스입니다. 더 이상 필요하지 않은 경우, 요금이 부과되지 않도록 구독에서 삭제합니다.


<br/> 
